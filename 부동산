import React, { useEffect, useMemo, useState } from "react";
import { AlertTriangle, TrendingUp, TrendingDown, Activity, Filter, BarChart2, ArrowUpAZ, ArrowDownAZ, Loader2 } from "lucide-react";

// íƒ€ì… ì •ì˜
type Trade = {
  id: number;
  district: string; // êµ¬
  dong: string;     // ë™
  complex: string;  // ë‹¨ì§€ëª…
  area: number;     // ì „ìš©ë©´ì (ã¡)
  price: number;    // ê±°ë˜ê¸ˆì•¡(ë§Œì›)
  date: string;     // YYYY-MM
  floor: number;
  buildYear: number;
};

// ìœ í‹¸
const toPy = (m2: number) => m2 * 0.3025; // 1ã¡ â‰ˆ 0.3025í‰
const pricePerPy = (price: number, m2: number) => price / toPy(m2);
const keyOf = (d: Trade) => `${d.complex}__${d.area}__${d.date}`; // ì›”Â·ë‹¨ì§€Â·ë©´ì  ê·¸ë£¹í‚¤
const stddev = (arr: number[]) => {
  if (arr.length < 2) return 0;
  const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
  const variance = arr.reduce((s, x) => s + (x - mean) ** 2, 0) / (arr.length - 1);
  return Math.sqrt(variance);
};

export default function AnomalyDetectionSystem() {
  // â–¼ ë°ì´í„° ë¡œë”© ìƒíƒœ
  const [raw, setRaw] = useState<Trade[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // â–¼ UI ìƒíƒœ
  const [selectedDistrict, setSelectedDistrict] = useState<string>("ì „ì²´");
  const [minAnomalyScore, setMinAnomalyScore] = useState<number>(25);
  const [selectedMonth, setSelectedMonth] = useState<string>("ì „ì²´");
  const [sortBy, setSortBy] = useState<"score-desc" | "price-desc" | "price-asc">("score-desc");
  const [useZscore, setUseZscore] = useState<boolean>(true);

  // â–¼ ë°ì´í„° ë¡œë”© (public/daejeon_trades_2025.json)
  useEffect(() => {
    const url = "/daejeon_trades_2025.json"; // public í´ë” ê¸°ì¤€ ê²½ë¡œ
    setLoading(true);
    setError(null);
    fetch(url)
      .then(async (r) => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = (await r.json()) as Trade[];
        // ê¸°ë³¸ ê²€ì¦ (í•„ìˆ˜ í•„ë“œ ì¡´ì¬ ì—¬ë¶€)
        const ok = Array.isArray(data) && data.every(d =>
          d && typeof d.district === 'string' && typeof d.complex === 'string' && typeof d.area === 'number' && typeof d.price === 'number'
        );
        if (!ok) throw new Error("ë°ì´í„° ìŠ¤í‚¤ë§ˆê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.");
        setRaw(data);
      })
      .catch((e) => setError(e.message || String(e)))
      .finally(() => setLoading(false));
  }, []);

  // â–¼ íŒŒìƒ ê°’: ì›”, êµ¬ ëª©ë¡
  const months = useMemo(() => ["ì „ì²´", ...Array.from(new Set(raw.map(d => d.date))).sort()], [raw]);
  const districts = useMemo(() => ["ì „ì²´", ...Array.from(new Set(raw.map(d => d.district)))], [raw]);

  // â–¼ ê·¸ë£¹ í†µê³„ (ì›”Â·ë‹¨ì§€Â·ë©´ì  ê¸°ì¤€)
  const groupStats = useMemo(() => {
    const map = new Map<string, { avg: number; std: number }>();
    const bucket = new Map<string, number[]>();
    for (const d of raw) {
      if (selectedMonth !== "ì „ì²´" && d.date !== selectedMonth) continue;
      const k = keyOf(d);
      if (!bucket.has(k)) bucket.set(k, []);
      bucket.get(k)!.push(d.price);
    }
    for (const [k, arr] of bucket) {
      const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
      const s = stddev(arr);
      map.set(k, { avg, std: s });
    }
    return map;
  }, [raw, selectedMonth]);

  // â–¼ ì´ìƒì¹˜ ì‚°ì • ë° ì •ë ¬
  const enriched = useMemo(() => {
    return raw
      .filter(d => (selectedDistrict === "ì „ì²´" || d.district === selectedDistrict))
      .filter(d => (selectedMonth === "ì „ì²´" || d.date === selectedMonth))
      .map(d => {
        const g = groupStats.get(keyOf(d));
        const avg = g?.avg ?? d.price;
        const sd = g?.std ?? 0;
        const deviationPct = ((d.price - avg) / (avg || 1)) * 100;
        const py = Math.round(pricePerPy(d.price, d.area));
        const avgPy = Math.round(pricePerPy(avg, d.area));
        const pyDeviation = Math.abs(py - avgPy);
        const z = sd > 0 ? (d.price - avg) / sd : 0;

        let score = 0;
        const reasons: string[] = [];
        if (deviationPct > 30) { score += 40; reasons.push("ê¸‰ê²©í•œ ê°€ê²© ìƒìŠ¹"); }
        if (deviationPct < -20) { score += 35; reasons.push("ê¸‰ê²©í•œ ê°€ê²© í•˜ë½"); }
        if (d.floor <= 5 && deviationPct > 10) { score += 15; reasons.push("ì €ì¸µ ê°€ê²© ì´ìƒ"); }
        if (pyDeviation > avgPy * 0.25) { score += 20; reasons.push("í‰ë‹¹ê°€ ì´ìƒ"); }
        if (useZscore && Math.abs(z) >= 2) { score += 25; reasons.push(`Z-score ${z.toFixed(1)}Ïƒ ì´ìƒ`); }

        return {
          ...d,
          avgPrice: Math.round(avg),
          deviationPct,
          pricePerPy: py,
          avgPricePerPy: avgPy,
          z,
          anomalyScore: Math.min(100, Math.round(score)),
          anomalyReasons: reasons,
          isAnomaly: score >= minAnomalyScore,
        };
      })
      .sort((a, b) => {
        if (sortBy === "score-desc") return b.anomalyScore - a.anomalyScore;
        if (sortBy === "price-desc") return b.price - a.price;
        return a.price - b.price;
      });
  }, [raw, selectedDistrict, selectedMonth, minAnomalyScore, useZscore, sortBy, groupStats]);

  // â–¼ í†µê³„
  const stats = useMemo(() => {
    const anomalies = enriched.filter(d => d.isAnomaly);
    const high = anomalies.filter(d => d.deviationPct > 0).length;
    const low = anomalies.filter(d => d.deviationPct < 0).length;
    return {
      total: enriched.length,
      anomalies: anomalies.length,
      high,
      low,
      rate: enriched.length ? ((anomalies.length / enriched.length) * 100).toFixed(1) : "0.0",
    };
  }, [enriched]);

  const visible = enriched.filter(d => d.isAnomaly);

  // â–¼ ë¡œë”©/ì—ëŸ¬ í™”ë©´
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div className="bg-white rounded-xl shadow p-6 flex items-center gap-3 text-gray-700">
          <Loader2 className="animate-spin" /> ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-red-50">
        <div className="bg-white border border-red-200 rounded-xl shadow p-6 text-red-700">
          <div className="font-semibold mb-1">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>
          <div className="text-sm">{error}</div>
          <div className="text-xs text-gray-500 mt-2">public/daejeon_trades_2025.json ìœ„ì¹˜ì™€ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-7xl mx-auto">
        {/* í—¤ë” */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-3">
            <AlertTriangle className="text-orange-500" size={32} />
            ëŒ€ì „ê´‘ì—­ì‹œ ë¶€ë™ì‚° ì´ìƒê±°ë˜ íƒì§€ ì‹œìŠ¤í…œ
          </h1>
          <p className="text-gray-600">ë™ì¼ ì›”Â·ë‹¨ì§€Â·ë©´ì  ê¸°ì¤€ í†µê³„ + Z-score ê¸°ë°˜ ì •ëŸ‰ íƒì§€</p>
        </div>

        {/* í†µê³„ ì¹´ë“œ */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div className="bg-white rounded-lg shadow p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">ë¶„ì„ ëŒ€ìƒ</p>
                <p className="text-2xl font-bold text-gray-800">{stats.total}ê±´</p>
              </div>
              <Activity className="text-blue-500" size={32} />
            </div>
          </div>
          <div className="bg-white rounded-lg shadow p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">ì´ìƒê±°ë˜</p>
                <p className="text-2xl font-bold text-orange-600">{stats.anomalies}ê±´</p>
                <p className="text-xs text-gray-500">({stats.rate}%)</p>
              </div>
              <AlertTriangle className="text-orange-500" size={32} />
            </div>
          </div>
          <div className="bg-white rounded-lg shadow p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">ê¸‰ë“± ì˜ì‹¬</p>
                <p className="text-2xl font-bold text-red-600">{stats.high}ê±´</p>
              </div>
              <TrendingUp className="text-red-500" size={32} />
            </div>
          </div>
          <div className="bg-white rounded-lg shadow p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">ê¸‰ë½ ì˜ì‹¬</p>
                <p className="text-2xl font-bold text-blue-600">{stats.low}ê±´</p>
              </div>
              <TrendingDown className="text-blue-500" size={32} />
            </div>
          </div>
        </div>

        {/* í•„í„° */}
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <div className="flex items-center gap-2 mb-4">
            <Filter size={20} className="text-gray-600" />
            <h2 className="text-lg font-semibold text-gray-800">í•„í„° ë° ì •ë ¬</h2>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">ìì¹˜êµ¬</label>
              <select value={selectedDistrict} onChange={(e) => setSelectedDistrict(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                {districts.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">ì›” ì„ íƒ</label>
              <select value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                {months.map(m => <option key={m} value={m}>{m}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">ë¯¼ê°ë„: {minAnomalyScore}ì  ì´ìƒ</label>
              <input type="range" min={10} max={70} step={5} value={minAnomalyScore} onChange={(e) => setMinAnomalyScore(parseInt(e.target.value))} className="w-full" />
              <div className="flex justify-between text-xs text-gray-500 mt-1"><span>ë‚®ìŒ</span><span>ë†’ìŒ</span></div>
            </div>
          </div>

          <div className="mt-4 flex flex-col md:flex-row gap-3 items-start md:items-center">
            <label className="inline-flex items-center gap-2 text-sm text-gray-700">
              <input type="checkbox" className="rounded border-gray-300" checked={useZscore} onChange={(e) => setUseZscore(e.target.checked)} />
              Z-score ê·œì¹™ ì‚¬ìš© (Â±2Ïƒ)
            </label>
            <div className="ml-auto flex items-center gap-2">
              <span className="text-sm text-gray-700">ì •ë ¬</span>
              <select value={sortBy} onChange={(e) => setSortBy(e.target.value as any)} className="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="score-desc">ìœ„í—˜ë„ ë†’ì€ ìˆœ</option>
                <option value="price-desc">ê°€ê²© ë†’ì€ ìˆœ</option>
                <option value="price-asc">ê°€ê²© ë‚®ì€ ìˆœ</option>
              </select>
              {sortBy === 'price-desc' ? <ArrowDownAZ size={18} className="text-gray-500"/> : sortBy === 'price-asc' ? <ArrowUpAZ size={18} className="text-gray-500"/> : <BarChart2 size={18} className="text-gray-500"/>}
            </div>
          </div>
        </div>

        {/* ì´ìƒê±°ë˜ í‘œ */}
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <div className="p-6 border-b border-gray-200">
            <h2 className="text-xl font-semibold text-gray-800">ì´ìƒê±°ë˜ íƒì§€ ê²°ê³¼ ({visible.length}ê±´)</h2>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìœ„í—˜ë„</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìì¹˜êµ¬</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë‹¨ì§€ëª…</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë©´ì </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê±°ë˜ê°€</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">í‰ë‹¹ê°€</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">í¸ì°¨(%)</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Z</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ìƒì‚¬ìœ </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {visible.length === 0 ? (
                  <tr>
                    <td colSpan={9} className="px-4 py-8 text-center text-gray-500">íƒì§€ëœ ì´ìƒê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                  </tr>
                ) : (
                  visible.map(item => (
                    <tr key={item.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3">
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-sm ${item.anomalyScore >= 70 ? 'bg-red-100 text-red-700' : item.anomalyScore >= 40 ? 'bg-orange-100 text-orange-700' : 'bg-yellow-100 text-yellow-700'}`}>
                          {item.anomalyScore}
                        </div>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900">{item.district}</td>
                      <td className="px-4 py-3">
                        <div className="text-sm font-medium text-gray-900">{item.complex}</div>
                        <div className="text-xs text-gray-500">{item.dong} / {item.floor}ì¸µ / {item.date}</div>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900">{item.area}ã¡</td>
                      <td className="px-4 py-3">
                        <div className="text-sm font-semibold text-gray-900">{item.price.toLocaleString()}ë§Œì›</div>
                        <div className="text-xs text-gray-500">í‰ê· : {item.avgPrice.toLocaleString()}ë§Œì›</div>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900">{item.pricePerPy.toLocaleString()}ë§Œì›</td>
                      <td className="px-4 py-3">
                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.deviationPct > 0 ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`}>
                          {item.deviationPct > 0 ? '+' : ''}{item.deviationPct.toFixed(1)}%
                        </span>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900">{item.z.toFixed(1)}</td>
                      <td className="px-4 py-3">
                        <div className="flex flex-wrap gap-1">
                          {item.anomalyReasons.map((r: string, i: number) => <span key={i} className="inline-flex px-2 py-1 text-xs bg-orange-50 text-orange-700 rounded">{r}</span>)}
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* ì•ˆë‚´ */}
        <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 className="text-sm font-semibold text-blue-800 mb-2">ğŸ“Š íƒì§€ ì•Œê³ ë¦¬ì¦˜</h3>
          <ul className="text-sm text-blue-700 space-y-1">
            <li>â€¢ <strong>ì§‘ê³„ ê¸°ì¤€</strong>: ë™ì¼ <em>ì›”Â·ë‹¨ì§€Â·ë©´ì </em> ê·¸ë£¹ í‰ê·  ë° í‘œì¤€í¸ì°¨ ì‚¬ìš©</li>
            <li>â€¢ <strong>ê¸‰ê²©í•œ ê°€ê²© ìƒìŠ¹</strong>: ê·¸ë£¹ í‰ê·  ëŒ€ë¹„ +30% ì´ìƒ</li>
            <li>â€¢ <strong>ê¸‰ê²©í•œ ê°€ê²© í•˜ë½</strong>: ê·¸ë£¹ í‰ê·  ëŒ€ë¹„ âˆ’20% ì´í•˜</li>
            <li>â€¢ <strong>ì €ì¸µ ê°€ê²© ì´ìƒ</strong>: 5ì¸µ ì´í•˜ì´ë©´ì„œ +10% ì´ˆê³¼</li>
            <li>â€¢ <strong>í‰ë‹¹ê°€ ì´ìƒ</strong>: ê·¸ë£¹ í‰ê·  í‰ë‹¹ê°€ ëŒ€ë¹„ 25% ì´ˆê³¼</li>
            <li>â€¢ <strong>Z-score</strong>: |Z| â‰¥ 2 ì‹œ ì¶”ê°€ ê°€ì (ì„ íƒ)</li>
          </ul>
        </div>
      </div>
    </div>
  );
}
